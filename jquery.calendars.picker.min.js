/* http://keith-wood.name/calendars.html
   Calendars date picker for jQuery v1.0.0.
   Written by Keith Wood (kbwood{at}iinet.com.au) August 2009.
   Dual licensed under the GPL (http://dev.jquery.com/browser/trunk/jquery/GPL-LICENSE.txt) and 
   MIT (http://dev.jquery.com/browser/trunk/jquery/MIT-LICENSE.txt) licenses. 
   Please attribute the author if you use it. */
(function($){function CalendarsPicker(){this._defaults={calendar:$.calendars.instance(),pickerClass:'',showOnFocus:true,showTrigger:null,showAnim:'show',showOptions:{},showSpeed:'normal',popupContainer:null,alignment:'bottom',fixedWeeks:false,firstDay:null,calculateWeek:null,monthsToShow:1,monthsOffset:0,monthsToStep:1,monthsToJump:12,changeMonth:true,yearRange:'c-10:c+10',showOtherMonths:false,selectOtherMonths:false,defaultDate:null,selectDefaultDate:false,minDate:null,maxDate:null,dateFormat:null,autoSize:false,rangeSelect:false,rangeSeparator:' - ',multiSelect:0,multiSeparator:',',onDate:null,onShow:null,onChangeMonthYear:null,onSelect:null,onClose:null,altField:null,altFormat:null,constrainInput:true,commandsAsDateFormat:false,commands:this.commands};this.regional={'':{renderer:this.defaultRenderer,prevText:'&lt;Prev',prevStatus:'Show the previous month',prevJumpText:'&lt;&lt;',prevJumpStatus:'Show the previous year',nextText:'Next&gt;',nextStatus:'Show the next month',nextJumpText:'&gt;&gt;',nextJumpStatus:'Show the next year',currentText:'Current',currentStatus:'Show the current month',todayText:'Today',todayStatus:'Show today\'s month',clearText:'Clear',clearStatus:'Clear all the dates',closeText:'Close',closeStatus:'Close the datepicker',yearStatus:'Change the year',monthStatus:'Change the month',weekText:'Wk',weekStatus:'Week of the year',dayStatus:'Select DD, M d, yyyy',defaultStatus:'Select a date',isRTL:false}};$.extend(this._defaults,this.regional['']);this._disabled=[]}$.extend(CalendarsPicker.prototype,{dataName:'calendarsPicker',markerClass:'hasCalendarsPicker',_popupClass:'calendars-popup',_triggerClass:'calendars-trigger',_disableClass:'calendars-disable',_coverClass:'calendars-cover',_monthYearClass:'calendars-month-year',_curMonthClass:'calendars-month-',_anyYearClass:'calendars-any-year',_curDoWClass:'calendars-dow-',commands:{prev:{text:'prevText',status:'prevStatus',keystroke:{keyCode:33},enabled:function(inst){var minDate=inst.curMinDate();return(!minDate||inst.drawDate.newDate().add(1-inst.get('monthsToStep')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay).add(-1,'d').compareTo(minDate)!=-1)},date:function(inst){return inst.drawDate.newDate().add(-inst.get('monthsToStep')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay)},action:function(inst){$.calendars.picker.changeMonth(this,-inst.get('monthsToStep'))}},prevJump:{text:'prevJumpText',status:'prevJumpStatus',keystroke:{keyCode:33,ctrlKey:true},enabled:function(inst){var minDate=inst.curMinDate();return(!minDate||inst.drawDate.newDate().add(1-inst.get('monthsToJump')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay).add(-1,'d').compareTo(minDate)!=-1)},date:function(inst){return inst.drawDate.newDate().add(-inst.get('monthsToJump')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay)},action:function(inst){$.calendars.picker.changeMonth(this,-inst.get('monthsToJump'))}},next:{text:'nextText',status:'nextStatus',keystroke:{keyCode:34},enabled:function(inst){var maxDate=inst.get('maxDate');return(!maxDate||inst.drawDate.newDate().add(inst.get('monthsToStep')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay).compareTo(maxDate)!=+1)},date:function(inst){return inst.drawDate.newDate().add(inst.get('monthsToStep')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay)},action:function(inst){$.calendars.picker.changeMonth(this,inst.get('monthsToStep'))}},nextJump:{text:'nextJumpText',status:'nextJumpStatus',keystroke:{keyCode:34,ctrlKey:true},enabled:function(inst){var maxDate=inst.get('maxDate');return(!maxDate||inst.drawDate.newDate().add(inst.get('monthsToJump')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay).compareTo(maxDate)!=+1)},date:function(inst){return inst.drawDate.newDate().add(inst.get('monthsToJump')-inst.get('monthsOffset'),'m').day(inst.get('calendar').minDay)},action:function(inst){$.calendars.picker.changeMonth(this,inst.get('monthsToJump'))}},current:{text:'currentText',status:'currentStatus',keystroke:{keyCode:36,ctrlKey:true},enabled:function(inst){var minDate=inst.curMinDate();var maxDate=inst.get('maxDate');var curDate=inst.selectedDates[0]||inst.get('calendar').today();return(!minDate||curDate.compareTo(minDate)!=-1)&&(!maxDate||curDate.compareTo(maxDate)!=+1)},date:function(inst){return inst.selectedDates[0]||inst.get('calendar').today()},action:function(inst){var curDate=inst.selectedDates[0]||inst.get('calendar').today();$.calendars.picker.showMonth(this,curDate.year(),curDate.month())}},today:{text:'todayText',status:'todayStatus',keystroke:{keyCode:36,ctrlKey:true},enabled:function(inst){var minDate=inst.curMinDate();var maxDate=inst.get('maxDate');return(!minDate||inst.get('calendar').today().compareTo(minDate)!=-1)&&(!maxDate||inst.get('calendar').today().compareTo(maxDate)!=+1)},date:function(inst){return inst.get('calendar').today()},action:function(inst){$.calendars.picker.showMonth(this)}},clear:{text:'clearText',status:'clearStatus',keystroke:{keyCode:35,ctrlKey:true},enabled:function(inst){return true},date:function(inst){return null},action:function(inst){$.calendars.picker.clear(this)}},close:{text:'closeText',status:'closeStatus',keystroke:{keyCode:27},enabled:function(inst){return true},date:function(inst){return null},action:function(inst){$.calendars.picker.hide(this)}},prevWeek:{text:'prevWeekText',status:'prevWeekStatus',keystroke:{keyCode:38,ctrlKey:true},enabled:function(inst){var minDate=inst.curMinDate();return(!minDate||inst.drawDate.newDate().add(-inst.get('calendar').daysInWeek(),'d').compareTo(minDate)!=-1)},date:function(inst){return inst.drawDate.newDate().add(-inst.get('calendar').daysInWeek(),'d')},action:function(inst){$.calendars.picker.changeDay(this,-inst.get('calendar').daysInWeek())}},prevDay:{text:'prevDayText',status:'prevDayStatus',keystroke:{keyCode:37,ctrlKey:true},enabled:function(inst){var minDate=inst.curMinDate();return(!minDate||inst.drawDate.newDate().add(-1,'d').compareTo(minDate)!=-1)},date:function(inst){return inst.drawDate.newDate().add(-1,'d')},action:function(inst){$.calendars.picker.changeDay(this,-1)}},nextDay:{text:'nextDayText',status:'nextDayStatus',keystroke:{keyCode:39,ctrlKey:true},enabled:function(inst){var maxDate=inst.get('maxDate');return(!maxDate||inst.drawDate.newDate().add(1,'d').compareTo(maxDate)!=+1)},date:function(inst){return inst.drawDate.newDate().add(1,'d')},action:function(inst){$.calendars.picker.changeDay(this,1)}},nextWeek:{text:'nextWeekText',status:'nextWeekStatus',keystroke:{keyCode:40,ctrlKey:true},enabled:function(inst){var maxDate=inst.get('maxDate');return(!maxDate||inst.drawDate.newDate().add(inst.get('calendar').daysInWeek(),'d').compareTo(maxDate)!=+1)},date:function(inst){return inst.drawDate.newDate().add(inst.get('calendar').daysInWeek(),'d')},action:function(inst){$.calendars.picker.changeDay(this,inst.get('calendar').daysInWeek())}}},defaultRenderer:{picker:'<div class="calendars">'+'<div class="calendars-nav">{link:prev}{link:today}{link:next}</div>{months}'+'{popup:start}<div class="calendars-ctrl">{link:clear}{link:close}</div>{popup:end}'+'<div class="calendars-clear-fix"></div></div>',monthRow:'<div class="calendars-month-row">{months}</div>',month:'<div class="calendars-month"><div class="calendars-month-header">{monthHeader}</div>'+'<table><thead>{weekHeader}</thead><tbody>{weeks}</tbody></table></div>',weekHeader:'<tr>{days}</tr>',dayHeader:'<th>{day}</th>',week:'<tr>{days}</tr>',day:'<td>{day}</td>',monthSelector:'.calendars-month',daySelector:'td',rtlClass:'calendars-rtl',multiClass:'calendars-multi',defaultClass:'',selectedClass:'calendars-selected',highlightedClass:'calendars-highlight',todayClass:'calendars-today',otherMonthClass:'calendars-other-month',weekendClass:'calendars-weekend',commandClass:'calendars-cmd',commandButtonClass:'',commandLinkClass:'',disabledClass:'calendars-disabled'},setDefaults:function(settings){$.extend(this._defaults,settings||{});return this},_attachPicker:function(target,settings){target=$(target);if(target.hasClass(this.markerClass)){return}target.addClass(this.markerClass);var inst={target:target,selectedDates:[],drawDate:null,pickingRange:false,inline:($.inArray(target[0].nodeName.toLowerCase(),['div','span'])>-1),get:function(name){var value=this.settings[name]!==undefined?this.settings[name]:$.calendars.picker._defaults[name];if($.inArray(name,['defaultDate','minDate','maxDate'])>-1){value=this.get('calendar').determineDate(value,null,this.selectedDates[0],this.get('dateFormat'),{dayNames:this.get('dayNames'),dayNamesShort:this.get('dayNamesShort'),monthNames:this.get('monthNames'),monthNamesShort:this.get('monthNamesShort'),shortYearCutoff:this.get('shortYearCutoff')})}else if(name=='dateFormat'){value=value||this.get('calendar').local.dateFormat}return value},curMinDate:function(){return(this.pickingRange?this.selectedDates[0]:this.get('minDate'))}};$.data(target[0],this.dataName,inst);var inlineSettings=($.fn.metadata?target.metadata():{});inst.settings=$.extend({},settings||{},inlineSettings||{});if(inst.inline){this._update(target[0])}else{this._attachments(target,inst)}},options:function(target,name){var inst=$.data(target,this.dataName);return(inst?(name?(name=='all'?inst.settings:inst.settings[name]):$.calendars.picker._defaults):{})},option:function(target,settings,value){target=$(target);if(!target.hasClass(this.markerClass)){return}settings=settings||{};if(typeof settings=='string'){var name=settings;settings={};settings[name]=value}var inst=$.data(target[0],this.dataName);if(settings.calendar&&settings.calendar!=inst.get('calendar')){var discardDate=function(name){return(typeof inst.settings[name]=='object'?null:inst.settings[name])};settings=$.extend({defaultDate:discardDate('defaultDate'),minDate:discardDate('minDate'),maxDate:discardDate('maxDate')},settings);inst.selectedDates=[];inst.drawDate=null}var dates=inst.selectedDates;extendRemove(inst.settings,settings);this.setDate(target[0],dates,null,false,true);inst.pickingRange=false;var calendar=inst.get('calendar');inst.drawDate=this._checkMinMax((settings.defaultDate?inst.get('defaultDate'):inst.drawDate)||inst.get('defaultDate')||calendar.today(),inst).newDate();if(!inst.inline){this._attachments(target,inst)}if(inst.inline||inst.div){this._update(target[0])}},_attachments:function(target,inst){target.unbind('focus.'+this.dataName);if(inst.get('showOnFocus')){target.bind('focus.'+this.dataName,this.show)}if(inst.trigger){inst.trigger.remove()}var trigger=inst.get('showTrigger');inst.trigger=(!trigger?$([]):$(trigger).clone().addClass(this._triggerClass)[inst.get('isRTL')?'insertBefore':'insertAfter'](target).click(function(){if(!$.calendars.picker.isDisabled(target[0])){$.calendars.picker[$.calendars.picker.curInst==inst?'hide':'show'](target[0])}}));this._autoSize(target,inst);target.bind('keydown.'+this.dataName,this._keyDown).bind('keypress.'+this.dataName,this._keyPress).bind('keyup.'+this.dataName,this._keyUp);if(inst.get('selectDefaultDate')&&inst.get('defaultDate')&&inst.selectedDates.length==0){var calendar=inst.get('calendar');this.setDate(target[0],(inst.get('defaultDate')||calendar.today()).newDate())}},_autoSize:function(target,inst){if(inst.get('autoSize')&&!inst.inline){var calendar=inst.get('calendar');var date=calendar.newDate(2009,10,20);var dateFormat=inst.get('dateFormat');if(dateFormat.match(/[DM]/)){var findMax=function(names){var max=0;var maxI=0;for(var i=0;i<names.length;i++){if(names[i].length>max){max=names[i].length;maxI=i}}return maxI};date.month(findMax(calendar.local[dateFormat.match(/MM/)?'monthNames':'monthNamesShort'])+1);date.day(findMax(calendar.local[dateFormat.match(/DD/)?'dayNames':'dayNamesShort'])+20-date.dayOfWeek())}inst.target.attr('size',date.formatDate(dateFormat).length)}},destroy:function(target){target=$(target);if(!target.hasClass(this.markerClass)){return}var inst=$.data(target[0],this.dataName);if(inst.trigger){inst.trigger.remove()}target.removeClass(this.markerClass).empty().unbind('.'+this.dataName);if(inst.get('autoSize')&&!inst.inline){target.removeAttr('size')}$.removeData(target[0],this.dataName)},multipleEvents:function(fns){var funcs=arguments;return function(args){for(var i=0;i<funcs.length;i++){funcs[i].apply(this,arguments)}}},enable:function(target){var $target=$(target);if(!$target.hasClass(this.markerClass)){return}var inst=$.data(target,this.dataName);if(inst.inline)$target.children('.'+this._disableClass).remove().end().find('select').attr('disabled','');else{target.disabled=false;inst.trigger.filter('button.'+this._triggerClass).attr('disabled','').end().filter('img.'+this._triggerClass).css({opacity:'1.0',cursor:''})}this._disabled=$.map(this._disabled,function(value){return(value==target?null:value)})},disable:function(target){var $target=$(target);if(!$target.hasClass(this.markerClass))return;var inst=$.data(target,this.dataName);if(inst.inline){var inline=$target.children(':last');var offset=inline.offset();var relOffset={left:0,top:0};inline.parents().each(function(){if($(this).css('position')=='relative'){relOffset=$(this).offset();return false}});$target.prepend('<div class="'+this._disableClass+'" style="'+'width: '+inline.outerWidth()+'px; height: '+inline.outerHeight()+'px; left: '+(offset.left-relOffset.left)+'px; top: '+(offset.top-relOffset.top)+'px;"></div>').find('select').attr('disabled','disabled')}else{target.disabled=true;inst.trigger.filter('button.'+this._triggerClass).attr('disabled','disabled').end().filter('img.'+this._triggerClass).css({opacity:'0.5',cursor:'default'})}this._disabled=$.map(this._disabled,function(value){return(value==target?null:value)});this._disabled.push(target)},isDisabled:function(target){return(target&&$.inArray(target,this._disabled)>-1)},show:function(target){target=target.target||target;var inst=$.data(target,$.calendars.picker.dataName);if($.calendars.picker.curInst==inst){return}if($.calendars.picker.curInst){$.calendars.picker.hide($.calendars.picker.curInst,true)}if(inst){inst.selectedDates=$.calendars.picker._extractDates(inst,$(target).val());inst.pickingRange=false;inst.drawDate=$.calendars.picker._checkMinMax((inst.selectedDates[0]||inst.get('defaultDate')||inst.get('calendar').today()).newDate(),inst);$.calendars.picker.curInst=inst;$.calendars.picker._update(target,true);var offset=$.calendars.picker._checkOffset(inst);inst.div.css({left:offset.left,top:offset.top});var showAnim=inst.get('showAnim');var showSpeed=inst.get('showSpeed');var postProcess=function(){var borders=$.calendars.picker._getBorders(inst.div);inst.div.find('.'+$.calendars.picker._coverClass).css({left:-borders[0],top:-borders[1],width:inst.div.outerWidth()+borders[0],height:inst.div.outerHeight()+borders[1]})};if($.effects&&$.effects[showAnim]){inst.div.show(showAnim,inst.get('showOptions'),showSpeed,postProcess)}else{inst.div[showAnim||'show']((showAnim?showSpeed:''),postProcess)}if(!showAnim){postProcess()}}},_extractDates:function(inst,datesText){var calendar=inst.get('calendar');var dateFormat=inst.get('dateFormat');var multiSelect=inst.get('multiSelect');var rangeSelect=inst.get('rangeSelect');datesText=datesText.split(multiSelect?inst.get('multiSeparator'):(rangeSelect?inst.get('rangeSeparator'):'\x00'));var dates=[];for(var i=0;i<datesText.length;i++){try{var date=calendar.parseDate(dateFormat,datesText[i]);if(date){var found=false;for(var j=0;j<dates.length;j++){if(dates[j].compareTo(date)==0){found=true;break}}if(!found){dates.push(date)}}}catch(e){}}dates.splice(multiSelect||(rangeSelect?2:1),dates.length);if(rangeSelect&&dates.length==1){dates[1]=dates[0]}return dates},_update:function(target,hidden){target=$(target.target||target);var inst=$.data(target[0],$.calendars.picker.dataName);if(inst){if(inst.inline){target.html(this._generateContent(target[0],inst))}else if($.calendars.picker.curInst==inst){if(!inst.div){inst.div=$('<div></div>').addClass(this._popupClass).css({display:(hidden?'none':'static'),position:'absolute',left:target.offset().left,top:target.offset().top+target.outerHeight()}).appendTo($(inst.get('popupContainer')||'body'))}inst.div.html(this._generateContent(target[0],inst));target.focus()}if(inst.inline||$.calendars.picker.curInst==inst){var onChange=inst.get('onChangeMonthYear');if(onChange&&(!inst.prevDate||inst.prevDate.year()!=inst.drawDate.year()||inst.prevDate.month()!=inst.drawDate.month())){onChange.apply(target[0],[inst.drawDate.year(),inst.drawDate.month()])}}}},_updateInput:function(target,keyUp){var inst=$.data(target,this.dataName);if(inst){var value='';var altValue='';var sep=(inst.get('multiSelect')?inst.get('multiSeparator'):inst.get('rangeSeparator'));var calendar=inst.get('calendar');var dateFormat=inst.get('dateFormat')||calendar.local.dateFormat;var altFormat=inst.get('altFormat')||dateFormat;for(var i=0;i<inst.selectedDates.length;i++){value+=(keyUp?'':(i>0?sep:'')+calendar.formatDate(dateFormat,inst.selectedDates[i]));altValue+=(i>0?sep:'')+calendar.formatDate(altFormat,inst.selectedDates[i])}if(!inst.inline&&!keyUp){$(target).val(value)}$(inst.get('altField')).val(altValue);var onSelect=inst.get('onSelect');if(onSelect&&!keyUp&&!inst.inSelect){inst.inSelect=true;onSelect.apply(target,[inst.selectedDates]);inst.inSelect=false}}},_getBorders:function(elem){var convert=function(value){var extra=($.browser.msie?1:0);return{thin:1+extra,medium:3+extra,thick:5+extra}[value]||value};return[parseFloat(convert(elem.css('border-left-width'))),parseFloat(convert(elem.css('border-top-width')))]},_checkOffset:function(inst){var base=(inst.target.is(':hidden')&&inst.trigger?inst.trigger:inst.target);var offset=base.offset();var isFixed=false;$(inst.target).parents().each(function(){isFixed|=$(this).css('position')=='fixed';return!isFixed});if(isFixed&&$.browser.opera){offset.left-=document.documentElement.scrollLeft;offset.top-=document.documentElement.scrollTop}var browserWidth=document.documentElement.clientWidth;var browserHeight=document.documentElement.clientHeight;if(browserWidth==0){return offset}var alignment=inst.get('alignment');var isRTL=inst.get('isRTL');var scrollX=document.documentElement.scrollLeft||document.body.scrollLeft;var scrollY=document.documentElement.scrollTop||document.body.scrollTop;var above=offset.top-inst.div.outerHeight()-(isFixed&&$.browser.opera?document.documentElement.scrollTop:0);var below=offset.top+base.outerHeight();var alignL=offset.left;var alignR=offset.left+base.outerWidth()-inst.div.outerWidth()-(isFixed&&$.browser.opera?document.documentElement.scrollLeft:0);var tooWide=(offset.left+inst.div.outerWidth()-scrollX)>browserWidth;var tooHigh=(offset.top+inst.target.outerHeight()+inst.div.outerHeight()-scrollY)>browserHeight;if(alignment=='topLeft'){offset={left:alignL,top:above}}else if(alignment=='topRight'){offset={left:alignR,top:above}}else if(alignment=='bottomLeft'){offset={left:alignL,top:below}}else if(alignment=='bottomRight'){offset={left:alignR,top:below}}else if(alignment=='top'){offset={left:(isRTL||tooWide?alignR:alignL),top:above}}else{offset={left:(isRTL||tooWide?alignR:alignL),top:(tooHigh?above:below)}}offset.left=Math.max((isFixed?0:scrollX),offset.left-(isFixed?scrollX:0));offset.top=Math.max((isFixed?0:scrollY),offset.top-(isFixed?scrollY:0));return offset},_checkExternalClick:function(event){if(!$.calendars.picker.curInst){return}var target=$(event.target);if(!target.parents().andSelf().hasClass($.calendars.picker._popupClass)&&!target.hasClass($.calendars.picker.markerClass)&&!target.parents().andSelf().hasClass($.calendars.picker._triggerClass)){$.calendars.picker.hide($.calendars.picker.curInst)}},hide:function(target,immediate){var inst=$.data(target,this.dataName)||target;if(inst&&inst==$.calendars.picker.curInst){var showAnim=(immediate?'':inst.get('showAnim'));var showSpeed=inst.get('showSpeed');var postProcess=function(){inst.div.remove();inst.div=null;$.calendars.picker.curInst=null;var onClose=inst.get('onClose');if(onClose){onClose.apply(target,[inst.selectedDates])}};inst.div.stop();if($.effects&&$.effects[showAnim]){inst.div.hide(showAnim,inst.get('showOptions'),showSpeed,postProcess)}else{var hideAnim=(showAnim=='show'?'hide':(showAnim=='slideDown'?'slideUp':(showAnim=='fadeIn'?'fadeOut':'')));inst.div[hideAnim||'hide']((hideAnim?showSpeed:''),postProcess)}if(!showAnim){postProcess()}}},_keyDown:function(event){var target=event.target;var inst=$.data(target,$.calendars.picker.dataName);var handled=false;if(inst.div){if(event.keyCode==9){$.calendars.picker.hide(target)}else if(event.keyCode==13){$.calendars.picker.selectDate(target,$('a.'+inst.get('renderer').highlightedClass,inst.div)[0]);handled=true}else{var commands=inst.get('commands');for(var name in commands){var command=commands[name];if(command.keystroke.keyCode==event.keyCode&&!!command.keystroke.ctrlKey==(event.ctrlKey||event.metaKey)&&!!command.keystroke.altKey==event.altKey&&!!command.keystroke.shiftKey==event.shiftKey){$.calendars.picker.performAction(target,name);handled=true;break}}}}else{var command=inst.get('commands').current;if(command.keystroke.keyCode==event.keyCode&&!!command.keystroke.ctrlKey==(event.ctrlKey||event.metaKey)&&!!command.keystroke.altKey==event.altKey&&!!command.keystroke.shiftKey==event.shiftKey){$.calendars.picker.show(target);handled=true}}if(handled){event.preventDefault();event.stopPropagation()}inst.ctrlKey=((event.keyCode<48&&event.keyCode!=32)||event.ctrlKey||event.metaKey);return!handled},_keyPress:function(event){var target=event.target;var inst=$.data(target,$.calendars.picker.dataName);if(inst&&inst.get('constrainInput')){var ch=String.fromCharCode(event.keyCode||event.charCode);var allowedChars=$.calendars.picker._allowedChars(inst);return(inst.ctrlKey||ch<' '||!allowedChars||allowedChars.indexOf(ch)>-1)}return true},_allowedChars:function(inst){var dateFormat=inst.get('dateFormat');var allowedChars=(inst.get('multiSelect')?inst.get('multiSeparator'):(inst.get('rangeSelect')?inst.get('rangeSeparator'):''));var literal=false;var hasNum=false;for(var i=0;i<dateFormat.length;i++){var ch=dateFormat.charAt(i);if(literal){if(ch=="'"&&dateFormat.charAt(i+1)!="'"){literal=false}else{allowedChars+=ch}}else{switch(ch){case'd':case'm':case'o':case'w':allowedChars+=(hasNum?'':'0123456789');hasNum=true;break;case'y':case'@':case'!':allowedChars+=(hasNum?'':'0123456789')+'-';hasNum=true;break;case'J':allowedChars+=(hasNum?'':'0123456789')+'-.';hasNum=true;break;case'D':case'M':case'Y':return null;case"'":if(dateFormat.charAt(i+1)=="'"){allowedChars+="'"}else{literal=true}break;default:allowedChars+=ch}}}return allowedChars},_keyUp:function(event){var target=event.target;var inst=$.data(target,$.calendars.picker.dataName);if(inst&&!inst.ctrlKey){try{var dates=$.calendars.picker._extractDates(inst,inst.target.val());if(dates.length>0){$.calendars.picker.setDate(target,dates,null,true)}}catch(event){}}return true},clear:function(target){var inst=$.data(target,this.dataName);if(inst){inst.selectedDates=[];this.hide(target);if(inst.get('selectDefaultDate')&&inst.get('defaultDate')){var calendar=inst.get('calendar');this.setDate(target,(inst.get('defaultDate')||calendar.today()).newDate())}else{this._updateInput(target)}}},getDate:function(target){var inst=$.data(target,this.dataName);return(inst?inst.selectedDates:[])},setDate:function(target,dates,endDate,keyUp,setOpt){var inst=$.data(target,this.dataName);if(inst){if(!$.isArray(dates)){dates=[dates];if(endDate){dates.push(endDate)}}var calendar=inst.get('calendar');var dateFormat=inst.get('dateFormat');var minDate=inst.get('minDate');var maxDate=inst.get('maxDate');var curDate=inst.selectedDates[0];inst.selectedDates=[];for(var i=0;i<dates.length;i++){var date=calendar.determineDate(dates[i],null,curDate,dateFormat);if(date){if((!minDate||date.compareTo(minDate)!=-1)&&(!maxDate||date.compareTo(maxDate)!=+1)){var found=false;for(var j=0;j<inst.selectedDates.length;j++){if(inst.selectedDates[j].compareTo(date)==0){found=true;break}}if(!found){inst.selectedDates.push(date)}}}}var rangeSelect=inst.get('rangeSelect');inst.selectedDates.splice(inst.get('multiSelect')||(rangeSelect?2:1),inst.selectedDates.length);if(rangeSelect){switch(inst.selectedDates.length){case 1:inst.selectedDates[1]=inst.selectedDates[0];break;case 2:inst.selectedDates[1]=(inst.selectedDates[0].compareTo(inst.selectedDates[1])==+1?inst.selectedDates[0]:inst.selectedDates[1]);break}inst.pickingRange=false}inst.prevDate=(inst.drawDate?inst.drawDate.newDate():null);inst.drawDate=this._checkMinMax((inst.selectedDates[0]||inst.get('defaultDate')||calendar.today()).newDate(),inst);if(!setOpt){this._update(target);this._updateInput(target,keyUp)}}},performAction:function(target,action){var inst=$.data(target,this.dataName);if(inst&&!this.isDisabled(target)){var commands=inst.get('commands');if(commands[action]&&commands[action].enabled.apply(target,[inst])){commands[action].action.apply(target,[inst])}}},showMonth:function(target,year,month,day){var inst=$.data(target,this.dataName);if(inst&&(day!=null||(inst.drawDate.year()!=year||inst.drawDate.month()!=month))){inst.prevDate=inst.drawDate.newDate();var calendar=inst.get('calendar');var show=this._checkMinMax((year!=null?calendar.newDate(year,month,1):calendar.today()),inst);inst.drawDate.date(show.year(),show.month(),(day!=null?day:Math.min(inst.drawDate.day(),calendar.daysInMonth(show.year(),show.month()))));this._update(target)}},changeMonth:function(target,offset){var inst=$.data(target,this.dataName);if(inst){var date=inst.drawDate.newDate().add(offset,'m');this.showMonth(target,date.year(),date.month())}},changeDay:function(target,offset){var inst=$.data(target,this.dataName);if(inst){var date=inst.drawDate.newDate().add(offset,'d');this.showMonth(target,date.year(),date.month(),date.day())}},_checkMinMax:function(date,inst){var minDate=inst.get('minDate');var maxDate=inst.get('maxDate');date=(minDate&&date.compareTo(minDate)==-1?minDate.newDate():date);date=(maxDate&&date.compareTo(maxDate)==+1?maxDate.newDate():date);return date},retrieveDate:function(target,elem){var inst=$.data(target,this.dataName);return(!inst?null:inst.get('calendar').fromJD(parseFloat(elem.className.replace(/^.*jd(\d+\.5).*$/,'$1'))))},selectDate:function(target,elem){var inst=$.data(target,this.dataName);if(inst&&!this.isDisabled(target)){var date=this.retrieveDate(target,elem);var multiSelect=inst.get('multiSelect');var rangeSelect=inst.get('rangeSelect');if(multiSelect){var found=false;for(var i=0;i<inst.selectedDates.length;i++){if(date.compareTo(inst.selectedDates[i])==0){inst.selectedDates.splice(i,1);found=true;break}}if(!found&&inst.selectedDates.length<multiSelect){inst.selectedDates.push(date)}}else if(rangeSelect){if(inst.pickingRange){inst.selectedDates[1]=date}else{inst.selectedDates=[date,date]}inst.pickingRange=!inst.pickingRange}else{inst.selectedDates=[date]}this._updateInput(target);if(inst.inline||inst.pickingRange||inst.selectedDates.length<(multiSelect||(rangeSelect?2:1))){this._update(target)}else{this.hide(target)}}},_generateContent:function(target,inst){var calendar=inst.get('calendar');var renderer=inst.get('renderer');var monthsToShow=inst.get('monthsToShow');monthsToShow=($.isArray(monthsToShow)?monthsToShow:[1,monthsToShow]);inst.drawDate=this._checkMinMax(inst.drawDate||inst.get('defaultDate')||calendar.today(),inst);var drawDate=inst.drawDate.newDate().add(-inst.get('monthsOffset'),'m');var monthRows='';var months='';for(var row=0;row<monthsToShow[0];row++){for(var col=0;col<monthsToShow[1];col++){months+=this._generateMonth(target,inst,drawDate.year(),drawDate.month(),calendar,renderer,(row==0&&col==0));drawDate.add(1,'m')}monthRows+=this._prepare(renderer.monthRow,inst).replace(/\{months\}/,months);months=''}var picker=this._prepare(renderer.picker,inst).replace(/\{months\}/,monthRows).replace(/\{weekHeader\}/g,this._generateDayHeaders(inst,calendar,renderer))+($.browser.msie&&parseInt($.browser.version,10)<7&&!inst.inline?'<iframe src="javascript:void(0);" class="'+this._coverClass+'"></iframe>':'');var commands=inst.get('commands');var asDateFormat=inst.get('commandsAsDateFormat');var addCommand=function(type,open,close,name,classes){if(picker.indexOf('{'+type+':'+name+'}')==-1){return}var command=commands[name];var date=(asDateFormat?command.date.apply(target,[inst]):null);picker=picker.replace(new RegExp('\\{'+type+':'+name+'\\}','g'),'<'+open+(command.status?' title="'+inst.get(command.status)+'"':'')+' class="'+renderer.commandClass+' '+renderer.commandClass+'-'+name+' '+classes+(command.enabled(inst)?'':' '+renderer.disabledClass)+'">'+(date?date.formatDate(inst.get(command.text)):inst.get(command.text))+'</'+close+'>')};for(var name in commands){addCommand('button','button type="button"','button',name,renderer.commandButtonClass);addCommand('link','a href="javascript:void(0)"','a',name,renderer.commandLinkClass)}picker=$(picker);var self=this;picker.find(renderer.daySelector+' a').hover(function(){$(this).addClass(renderer.highlightedClass)},function(){(inst.inline?$(this).parents('.'+self.markerClass):inst.div).find(renderer.daySelector+' a').removeClass(renderer.highlightedClass)}).click(function(){self.selectDate(target,this)}).end().find('select.'+this._monthYearClass+':not(.'+this._anyYearClass+')').change(function(){var monthYear=$(this).val().split('/');self.showMonth(target,parseInt(monthYear[1],10),parseInt(monthYear[0],10))}).end().find('select.'+this._anyYearClass).click(function(){$(this).next('input').css({left:this.offsetLeft,top:this.offsetTop,width:this.offsetWidth,height:this.offsetHeight}).show().focus()}).end().find('input.'+self._monthYearClass).change(function(){try{var year=parseInt($(this).val(),10);year=(isNaN(year)?inst.drawDate.year():year);self.showMonth(target,year,inst.drawDate.month(),inst.drawDate.day())}catch(e){alert(e)}});picker.find('.'+renderer.commandClass).click(function(){if(!$(this).hasClass(renderer.disabledClass)){var action=this.className.replace(new RegExp('^.*'+renderer.commandClass+'-([^ ]+).*$'),'$1');$.calendars.picker.performAction(target,action)}});if(inst.get('isRTL')){picker.addClass(renderer.rtlClass)}if(monthsToShow[0]*monthsToShow[1]>1){picker.addClass(renderer.multiClass)}var pickerClass=inst.get('pickerClass');if(pickerClass){picker.addClass(pickerClass)}$('body').append(picker);picker.width(monthsToShow[1]*picker.find(renderer.monthSelector).outerWidth());var onShow=inst.get('onShow');if(onShow){onShow.apply(target,[picker,calendar,inst])}return picker},_generateMonth:function(target,inst,year,month,calendar,renderer,first){var daysInMonth=calendar.daysInMonth(year,month);var monthsToShow=inst.get('monthsToShow');monthsToShow=($.isArray(monthsToShow)?monthsToShow:[1,monthsToShow]);var fixedWeeks=inst.get('fixedWeeks')||(monthsToShow[0]*monthsToShow[1]>1);var firstDay=inst.get('firstDay');firstDay=(firstDay==null?calendar.local.firstDay:firstDay);var leadDays=(calendar.dayOfWeek(year,month,calendar.minDay)-firstDay+calendar.daysInWeek())%calendar.daysInWeek();var numWeeks=(fixedWeeks?6:Math.ceil((leadDays+daysInMonth)/calendar.daysInWeek()));var showOtherMonths=inst.get('showOtherMonths');var selectOtherMonths=inst.get('selectOtherMonths')&&showOtherMonths;var dayStatus=inst.get('dayStatus');var minDate=(inst.pickingRange?inst.selectedDates[0]:inst.get('minDate'));var maxDate=inst.get('maxDate');var rangeSelect=inst.get('rangeSelect');var onDate=inst.get('onDate');var showWeeks=renderer.week.indexOf('{weekOfYear}')>-1;var calculateWeek=inst.get('calculateWeek');var today=calendar.today();var drawDate=calendar.newDate(year,month,calendar.minDay);drawDate.add(-leadDays-(fixedWeeks&&drawDate.dayOfWeek()==firstDay?calendar.daysInWeek():0),'d');var jd=drawDate.toJD();var weeks='';for(var week=0;week<numWeeks;week++){var weekOfYear=(!showWeeks?'':'<span class="jd'+jd+'">'+(calculateWeek?calculateWeek(drawDate):drawDate.weekOfYear())+'</span>');var days='';for(var day=0;day<calendar.daysInWeek();day++){var selected=false;if(rangeSelect&&inst.selectedDates.length>0){selected=(drawDate.compareTo(inst.selectedDates[0])!=-1&&drawDate.compareTo(inst.selectedDates[1])!=+1)}else{for(var i=0;i<inst.selectedDates.length;i++){if(inst.selectedDates[i].compareTo(drawDate)==0){selected=true;break}}}var dateInfo=(!onDate?{}:onDate.apply(target,[drawDate,drawDate.month()==month]));var selectable=(dateInfo.selectable==null||dateInfo.selectable)&&(selectOtherMonths||drawDate.month()==month)&&(!minDate||drawDate.compareTo(minDate)!=-1)&&(!maxDate||drawDate.compareTo(maxDate)!=+1);days+=this._prepare(renderer.day,inst).replace(/\{day\}/g,(selectable?'<a href="javascript:void(0)"':'<span')+' class="jd'+jd+' '+(dateInfo.dateClass||'')+(selected&&(selectOtherMonths||drawDate.month()==month)?' '+renderer.selectedClass:'')+(selectable?' '+renderer.defaultClass:'')+(drawDate.weekDay()?'':' '+renderer.weekendClass)+(drawDate.month()==month?'':' '+renderer.otherMonthClass)+(drawDate.compareTo(today)==0&&drawDate.month()==month?' '+renderer.todayClass:'')+(drawDate.compareTo(inst.drawDate)==0&&drawDate.month()==month?' '+renderer.highlightedClass:'')+'"'+(dateInfo.title||(dayStatus&&selectable)?' title="'+(dateInfo.title||drawDate.formatDate(dayStatus))+'"':'')+'>'+(showOtherMonths||drawDate.month()==month?dateInfo.content||drawDate.day():'&nbsp;')+(selectable?'</a>':'</span>'));drawDate.add(1,'d');jd++}weeks+=this._prepare(renderer.week,inst).replace(/\{days\}/g,days).replace(/\{weekOfYear\}/g,weekOfYear)}var monthHeader=this._prepare(renderer.month,inst).match(/\{monthHeader(:[^\}]+)?\}/);monthHeader=(monthHeader[0].length<=13?'MM yyyy':monthHeader[0].substring(13,monthHeader[0].length-1));monthHeader=(first?this._generateMonthSelection(inst,year,month,minDate,maxDate,monthHeader,calendar,renderer):calendar.formatDate(monthHeader,calendar.newDate(year,month,calendar.minDay)));var weekHeader=this._prepare(renderer.weekHeader,inst).replace(/\{days\}/g,this._generateDayHeaders(inst,calendar,renderer));return this._prepare(renderer.month,inst).replace(/\{monthHeader(:[^\}]+)?\}/g,monthHeader).replace(/\{weekHeader\}/g,weekHeader).replace(/\{weeks\}/g,weeks)},_generateDayHeaders:function(inst,calendar,renderer){var firstDay=inst.get('firstDay');firstDay=(firstDay==null?calendar.local.firstDay:firstDay);var header='';for(var day=0;day<calendar.daysInWeek();day++){var dow=(day+firstDay)%calendar.daysInWeek();header+=this._prepare(renderer.dayHeader,inst).replace(/\{day\}/g,'<span class="'+this._curDoWClass+dow+'" title="'+calendar.local.dayNames[dow]+'">'+calendar.local.dayNamesMin[dow]+'</span>')}return header},_generateMonthSelection:function(inst,year,month,minDate,maxDate,monthHeader,calendar){if(!inst.get('changeMonth')){return calendar.formatDate(monthHeader,calendar.newDate(year,month,1))}var monthNames=calendar.local['monthNames'+(monthHeader.match(/mm/i)?'':'Short')];var html=monthHeader.replace(/m+/i,'\\x2E').replace(/y+/i,'\\x2F');var selector='<select class="'+this._monthYearClass+'" title="'+inst.get('monthStatus')+'">';var maxMonth=calendar.monthsInYear(year)+calendar.minMonth;for(var m=calendar.minMonth;m<maxMonth;m++){if((!minDate||calendar.newDate(year,m,calendar.daysInMonth(year,m)-1+calendar.minDay).compareTo(minDate)!=-1)&&(!maxDate||calendar.newDate(year,m,calendar.minDay).compareTo(maxDate)!=+1)){selector+='<option value="'+m+'/'+year+'"'+(month==m?' selected="selected"':'')+'>'+monthNames[m-calendar.minMonth]+'</option>'}}selector+='</select>';html=html.replace(/\\x2E/,selector);var yearRange=inst.get('yearRange');if(yearRange=='any'){selector='<select class="'+this._monthYearClass+' '+this._anyYearClass+'" title="'+inst.get('yearStatus')+'">'+'<option>'+year+'</option></select>'+'<input class="'+this._monthYearClass+' '+this._curMonthClass+month+'" value="'+year+'">'}else{yearRange=yearRange.split(':');var todayYear=calendar.today().year();var start=(yearRange[0].match('c[+-].*')?year+parseInt(yearRange[0].substring(1),10):((yearRange[0].match('[+-].*')?todayYear:0)+parseInt(yearRange[0],10)));var end=(yearRange[1].match('c[+-].*')?year+parseInt(yearRange[1].substring(1),10):((yearRange[1].match('[+-].*')?todayYear:0)+parseInt(yearRange[1],10)));selector='<select class="'+this._monthYearClass+'" title="'+inst.get('yearStatus')+'">';var min=calendar.newDate(start+1,calendar.firstMonth,calendar.minDay).add(-1,'d');min=(minDate&&minDate.compareTo(min)==+1?minDate:min).year();var max=calendar.newDate(end,calendar.firstMonth,calendar.minDay);max=(maxDate&&maxDate.compareTo(max)==-1?maxDate:max).year();for(var y=min;y<=max;y++){if(y!=0||calendar.hasYearZero){selector+='<option value="'+Math.min(month,calendar.monthsInYear(y)-1+calendar.minMonth)+'/'+y+'"'+(year==y?' selected="selected"':'')+'>'+y+'</option>'}}selector+='</select>'}html=html.replace(/\\x2F/,selector);return html},_prepare:function(text,inst){var replaceSection=function(type,retain){while(true){var start=text.indexOf('{'+type+':start}');if(start==-1){return}var end=text.substring(start).indexOf('{'+type+':end}');if(end>-1){text=text.substring(0,start)+(retain?text.substr(start+type.length+8,end-type.length-8):'')+text.substring(start+end+type.length+6)}}};replaceSection('inline',inst.inline);replaceSection('popup',!inst.inline);var pattern=/\{l10n:([^\}]+)\}/;var matches=null;while(matches=pattern.exec(text)){text=text.replace(matches[0],inst.get(matches[1]))}return text}});function extendRemove(target,props){$.extend(target,props);for(var name in props)if(props[name]==null||props[name]==undefined)target[name]=props[name];return target};$.fn.calendarsPicker=function(options){var otherArgs=Array.prototype.slice.call(arguments,1);if($.inArray(options,['getDate','isDisabled','options','retrieveDate'])>-1){return $.calendars.picker[options].apply($.calendars.picker,[this[0]].concat(otherArgs))}return this.each(function(){if(typeof options=='string'){$.calendars.picker[options].apply($.calendars.picker,[this].concat(otherArgs))}else{$.calendars.picker._attachPicker(this,options||{})}})};$.calendars.picker=new CalendarsPicker();$(function(){$(document).mousedown($.calendars.picker._checkExternalClick).resize(function(){$.calendars.picker.hide($.calendars.picker.curInst)})})})(jQuery);
